<!DOCTYPE html>
<html lang="pl">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Responsive sidebar template with sliding effect and dropdown menu based on bootstrap 3">
  <title>Wczesnośredniowieczne grodziska</title>

  <!-- MAPBOX -->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
  	
  <!--JQuery  --> 
  
  <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css" />
  
  <script src="//code.jquery.com/jquery-1.12.4.js"></script>
  <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  		
  <!--Leaflet-->
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>   	

  <link rel='stylesheet prefetch' href='http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.css'>
  <script src='http://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.min.js'></script>		

  <!--Bootstrap-->			
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy" crossorigin="anonymous"> 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script> 
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/js/bootstrap.min.js" integrity="sha384-a5N7Y/aK3qNeh15eJKGWxsqtnX/wWdSZSKp+81YjTmS15nvnvxKHuzaWwXHDli+4" crossorigin="anonymous"></script> 

  <link rel="stylesheet" href="css/style.css">
</head>
  <body>
  	<nav class="navigation">
        <div class="container">
          <ul>
            <li class="iteam">
              <a class="logo" href="#">INTERAKTYWNA MAPA WCZESNOŚREDNIOWIECZNYCH GRODZISK WIELKOPOLSKI</a>
            </li>
            <li class="iteam">
              <a class="nav-link" href="glowna.html">STRONA GŁÓWNA</a>
            </li>
            <li class="iteam">
              <a class="nav-link" href="index.html">MAPA</a>
            </li>
          </ul>
        </div>
    </nav>
  <div class="container">
  	<div id="map">
  		<div id="panel">
  			<div id="menu" class="btn btn-primary" > MENU </div>
  				<div id="wrapper">
  					<div id="przyciski">
  						<button id="obszar" class="obszar btn" title="Wyświetlany powiat"></button> 
  						<button id="ksztalt" class="ksztalt btn" title="Kształt grodziska"></button> 
  						<div id="block"></div>
  						<button id="wyszukiwarka" class="wyszukiwarka btn" title="Znajdź grodzisko"><a href="#wrapper" class="dropdown-toggle" data-toggle="dropdown"></a></button> 
  						<button id="wiek" class="wiek btn" title="Wiek grodziska"><a href="#wrapper" class="dropdown-toggle" data-toggle="dropdown"></a></button> 
  					</div>
  				</div>
  		</div>
  	</div>
  	<div id="zasieg"  style="display:none">Wybór powiatu 
  			<br>
  				<select id="powiat"> 
  					<option value="powiat chodzieski">powiat chodzieski</option>
  					<option value="powiat czarnkowsko-trzcianecki">powiat czarnkowsko-trzcianecki</option> 
  					<option value="powiat gnieźnieński">powiat gnieźnieński</option> 
  					<option value="powiat gostyński">powiat gostyński</option> 
  					<option value="powiat grodziski">powiat grodziski</option> 
  					<option value="powiat jarociński">powiat jarociński</option> 
  					<option value="powiat kaliski">powiat kaliski</option> 
  					<option value="powiat Kalisz">powiat Kalisz</option>
  					<option value="powiat kępiński">powiat kępiński</option>
  					<option value="powiat kolski">powiat kolski</option>
  					<option value="powiat Konin">powiat Konin</option>
  					<option value="powiat koniński">powiat koniński</option>
  					<option value="powiat kościański">powiat kościański</option>
  					<option value="powiat krotoszyński">powiat krotoszyński</option>
  					<option value="powiat leszczyński">powiat leszczyński</option>
  					<option value="powiat Leszno">powiat Leszno</option>
  					<option value="powiat międzychodzki">powiat międzychodzki</option>
  					<option value="powiat nowotomyski">powiat nowotomyski</option>
  					<option value="powiat obornicki">powiat obornicki</option>
  					<option value="powiat ostrowski">powiat ostrowski</option>
  					<option value="powiat ostrzeszowski">powiat ostrzeszowski</option>
  					<option value="powiat pilski">powiat pilski</option>
  					<option value="powiat pleszewski">powiat pleszewski</option>
  					<option value="powiat Poznań">powiat Poznań</option>
  					<option value="powiat poznański">powiat poznański</option>
  					<option value="powiat rawicki">powiat rawicki</option>
  					<option value="powiat słupecki">powiat słupecki</option>
  					<option value="powiat szamotulski">powiat szamotulski</option>
  					<option value="powiat średzki">powiat średzki</option>
  					<option value="powiat śremski">powiat śremski</option>
  					<option value="powiat turecki">powiat turecki</option>
  					<option value="powiat wągrowiecki">powiat wągrowiecki</option>
  					<option value="powiat wolsztyński">powiat wolsztyński</option>
  					<option value="powiat wrzesiński">powiat wrzesiński</option>
  					<option value="powiat złotowski">powiat złotowski</option>
  				</select> 
  				<br>
  				<button id="set2" class="button btn" >Przybliż</button> 
  				<button id="clear2" class="button btn">Cofnij</button> 
  	</div> 
  	<div id="ksztalt_gr" style="display:none">Kształt grodziska
  		<br>
  			<select id="rodzaj" onchange="updatevariable(this.value)"> 
  				<option value="pierscieniowate">pierścieniowate</option>
  				<option value="stozkowate">stożkowate</option>  
  				<option value="nieznane">nieznane</option> 
  			</select>
  		<br>
  			<button id="set" class="button btn">Przybliż</button> 
  			<button id="clear" class="button btn">Cofnij</button> 
  	</div>
  	
  	<div id=wiek_gr style="display:none"> Wybór wieku
  		<div id="chronologia">
  			<input type="checkbox" value="V"><label>V</label>
  			<input type="checkbox" value="VI"><label>VI</label>
  		</div>
  		<div id="chronologia">
  			<input type="checkbox" value="VII"><label>VII</label>
  			<input type="checkbox" value="VIII"><label>VIII</label>
  		</div>
  		<div id="chronologia">
  			<input type="checkbox" value="IX"><label>IX</label>
  			<input type="checkbox" value="X"><label>X</label>
  			<input type="checkbox" value="XI"><label>XI</label>
  		</div>
  		<div id="chronologia">
  			<input type="checkbox" value="XII"><label>XII</label>
  			<input type="checkbox" value="XIII"><label>XIII</label>
  		</div>
  		<div id="chronologia">
  			<input type="checkbox" value="XIV"><label>XIV</label>
  			<input type="checkbox" value="XV"><label>XV</label>
  		</div>
  		<div id="chronologia">
  			<input type="checkbox" value="XVI"><label>XVI</label>
  			<input type="checkbox" value="XVII"><label>XVII</label>
  		</div>
  		<button id="search" class="button btn" >Szukaj</button>
  		<button id="clear3" class="button btn">Cofnij</button> 
  	</div>
  	
  	<div id=wyszukaj style="display:none"> Znajdź grodzisko
  		<input type="search" id="wstaw">
  		<button id="search1" class="button btn">Szukaj</button> 
  		<button id="clear4" class="button btn">Cofnij</button> 
  	</div>
  </div>
  <script>

// funkcje rozwijające i zwijające menu oraz poszczególne przyciski

  $(function()
  { 
    $('#menu').click(function(){ 
      $('#ksztalt_gr').slideUp('fast'); 
      $('#zasieg').slideUp('fast');
      $('#wiek_gr ').slideUp('fast'); 
      $('#wyszukaj').slideUp('fast'); 
      $('#przyciski').slideToggle('slow'); 
  		
    }); 
  });	

  $('#obszar').click(function()
  { 
    $('#wiek_gr ').slideUp('fast'); 
    $('#wyszukaj').slideUp('fast'); 
    $('#ksztalt_gr').slideUp('fast');
    $('#zasieg').slideToggle('slow'); 
  				
  }); 

  $('#ksztalt').click(function()
  { 	
    $('#wiek_gr ').slideUp('fast'); 
    $('#wyszukaj').slideUp('fast'); 	
    $('#zasieg').slideUp('fast');
    $('#ksztalt_gr').slideToggle('slow');
  }); 

  $('#wyszukiwarka').click(function()
  { 	
    $('#wiek_gr ').slideUp('fast'); 
    $('#wyszukaj').slideToggle('slow'); 	
    $('#zasieg').slideUp('fast');
    $('#ksztalt_gr').slideUp('fast');
  }); 

  $('#wiek').click(function()
  { 	
    $('#wiek_gr ').slideToggle('slow'); 
    $('#wyszukaj').slideUp('fast'); 	
    $('#zasieg').slideUp('fast');
    $('#ksztalt_gr').slideUp('fast');
  }); 

  /*wczytanie mapt za pomocą biblioteki Leaflet z mapboxa
  za pomocą setView ustawia sie domyslny widok*/
  var map = L.map('map').setView([52.40, 16.90], 10);
  var mapbox = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    maxZoom: 18,
    id: 'mapbox.light',
    accessToken:'pk.eyJ1IjoiZ29zaWFrMTAiLCJhIjoiY2puY3ZoN2h0NXNuZTN4bjEzODhveTA4MCJ9.p6Vx-joA-4K-VZTSPOX93w'});
  mapbox.addTo(map);


  //ikona dla grodziska
  let ikona = L.icon({
    iconUrl: 'css/castle1.png',
    iconSize: [20, 20]
  });

  /*funkcja tworząca geoJSON z grodziskami
  na poczatku ustalenie parametrów dla linku WFS,*/
  var grody; 

  let gs_url= 'http://localhost:8080/geoserver/wfs'; 
  function grodzisko() {
    //tworzenie parametrow dla linka WFS
    var defaultParam = { 
      service: 'WFS', 
      version: '1.1.0', 
      request: 'GetFeature', 
      typeName: 'grody:grodziska_84', 
      maxFeatures: 1000, 
      outputFormat: 'json', 
      format_options: 'callback:getJson', 
      srsName: 'epsg:4326',
    }; 
    var parameters = L.Util.extend(defaultParam); 
    var URL = gs_url + L.Util.getParamString(parameters);

    //stworzenie geoJSONA za pomoca  Ajax oraz blibiotek: jQuery oraz leaflet
    $.ajax ({ 
      url : URL,
      type: 'GET', 
      dataType : 'json', 
      jsonpCallback : 'getJson', 
      success : function (data) 
      { 
        grody = L.geoJson(data, { 
          pointToLayer: function (feature, latlng) { 
            return L.marker(latlng,{icon:ikona});  //zamiana stylu domyslnego na ikony
          }, 
          onEachFeature: function (feature, layer){
            //popup z wybranymi elementami ktore ma zawierac
            var popup = new L.Popup();
            popup.setContent(feature.properties.nazwa + '<li><b>Opis:</b> ' + feature.properties.opis +  '</li><li><b>Wiek:</b> ' + feature.properties.informacje + '</li><li><b>Kształt:</b> ' + feature.properties.funkcja_ii +  '</li><li><b>Źródło:</b> ' + feature.properties.zrodlo + '</li>');
            layer.bindPopup(popup);
          }
        });
  		 // dodanie do mapy grodow
        grody.addTo(map); 
      }
    }); 
  }
  grodzisko(); //wywolanie funkcji



  /*filtorwanie wedlug kształtu grodziska, 
  jeśli warunek jest spełniony to tworzy geoJSON z wybranym kształtem. 
  Dla każdego kształtu stworzono osobny widok w Geoserverze.
  Schemat tworzenia jest taki sam jak dla grodzisk. Tylko od razu zdefiniowano link do WFS.
  funkcja_ii jest to kolumna w bazie danych przechowujaca kształt
   */
  
  let funkcja_ii; 

  function przybliz(){
    if(funkcja_ii == 'pierscieniowate'){
      map.removeLayer(grody);
      $.ajax ({
        url :'http://localhost:8080/geoserver/grody/wfs?service=WFS&version=1.1.0&typename=grody:pierscieniowate&request=GetFeature&typeNames=featuretype&outputFormat=application/json',
        type : 'POST',
        dataType : 'json', 
        jsonpCallback : 'getJson',
        success : function (data)
        {
          grody = L.geoJson(data, {
            pointToLayer: function (feature, latlng) { 
              return L.marker(latlng,{icon:ikona});
            }, 
            onEachFeature: function(feature, layer){
              var popup = new L.Popup();
              popup.setContent(feature.properties.nazwa + '<li><b>Opis:</b> ' + feature.properties.opis + '</li><li><b>Wiek:</b> ' + feature.properties.informacje + '</li><li><b>Kształt:</b> ' + feature.properties.funkcja_ii + '</li><li><b>Źródło:</b> ' + feature.properties.zrodlo + '</li>');
              layer.bindPopup(popup);
            }
          }).addTo(map);
          map.fitBounds(grody); //fitBounds przybliża do obszaru
        }
      });
    }
    else if(funkcja_ii == 'stozkowate'){
      map.removeLayer(grody);
      $.ajax ({
        url : 'http://localhost:8080/geoserver/grody/wfs?service=WFS&version=1.1.0&typename=grody:stozkowate&request=GetFeature&typeNames=featuretype&outputFormat=application/json',
        type : 'POST',
        dataType : 'json',
        jsonpCallback : 'getJson',
        success : function (data)
        {
          grody = L.geoJson(data, {
            pointToLayer: function (feature, latlng) { 
              return L.marker(latlng,{icon:ikona});
            }, 
            onEachFeature: function(feature, layer){
              var popup = new L.Popup();
              popup.setContent(feature.properties.nazwa + '<li><b>Opis:</b> ' + feature.properties.opis +  '</li><li><b>Wiek:</b> ' + feature.properties.informacje + '</li><li><b>Kształt:</b> ' + feature.properties.funkcja_ii +  '</li><li><b>Źródło:</b> ' + feature.properties.zrodlo + '</li>');
              layer.bindPopup(popup);
            }
          }).addTo(map);
          map.fitBounds(grody);
        }
      });
    }
    else if(funkcja_ii == 'nieznane'){
      map.removeLayer(grody);
      $.ajax ({
        url :'http://localhost:8080/geoserver/grody/wfs?service=WFS&version=1.1.0&typename=grody:nieznane&request=GetFeature&typeNames=featuretype&outputFormat=application/json',
        type : 'POST',
        dataType : 'json',
        jsonpCallback : 'getJson',
        success : function (data)
        {
          grody = L.geoJson(data, {
            pointToLayer: function (feature, latlng) { 
              return L.marker(latlng,{icon:ikona});
            }, 
            onEachFeature: function(feature, layer){
              var popup = new L.Popup();
              popup.setContent(feature.properties.nazwa + '<li><b>Opis:</b> ' + feature.properties.opis + '</li><li><b>Wiek:</b> ' + feature.properties.informacje + '</li><li><b>Kształt:</b> ' + feature.properties.funkcja_ii + '</li><li><b>Źródło:</b> ' + feature.properties.zrodlo + '</li>');
              layer.bindPopup(popup);
            }
          }).addTo(map);
          map.fitBounds(grody);
        }
      });
    }
    else{
      console.log('brak danych');
    }
  }


//funkcja, która umożliwia powrót do domyślnego widoku
  function wymaz(){
    location.reload();
  }

//dodanie funkcji przybliż do przycisku 
  var setButton2 = document.getElementById('set'); 
  setButton2.addEventListener('click', przybliz);

//cofniecie do domyślengo widoku
  var clearButton2 = document.getElementById('clear'); 
  clearButton2.addEventListener('click', wymaz);

//funkcja aktualizująca wartości na podstawie wyboru listy*/
  function updatevariable(data) {
    funkcja_ii = data;
  }

//wszystkie powiaty
  var powiat;
  function powiaty() {
  $.ajax ({
    url :'http://localhost:8080/geoserver/grody/wfs?service=WFS&version=1.1.0&typename=grody:powiaty_84&request=GetFeature&typeNames=featuretype&outputFormat=application/json',
    type : 'GET',
    dataType : 'json',
    jsonpCallback : 'getJson',
    success : function (data)
    {
      powiat = L.geoJson(data, {
        style: function(feature) {
          return {color: 'black', fillColor: 'transparent', weight: 2};
        }
      }).addTo(map);

    }
  });
}

  powiaty();

  //filtrowanie wedlug powiatu

  /*powiaty pobrano z obiektu "powiat"(utoworzono widok o takiej nazwie w Geoserverze), 
  val() wstawia wartość taka jaka jest w bazie danych*/
  var powiaty_84;

  function zasieg(){
    if(map.hasLayer(powiaty_84))map.removeLayer(powiaty_84);
    nazwa=$('#powiat').val();  

    var viewparams = ['nazwa:' + nazwa];
    var defaultParam = {
      service: 'WFS',
      version: '1.1.0',
      request: 'GetFeature',
      typeName: ' grody:powiaty',
      maxFeatures: 1000,
      outputFormat: 'json',
      format_options: 'callback:getJson',
      srsName: 'epsg:4326',
      viewparams:  viewparams.join(';')
    };
    var parameters = L.Util.extend(defaultParam);
    var URL = gs_url + L.Util.getParamString(parameters);

    $.ajax({
      url : URL,
      type: 'GET',
      dataType : 'json',
      jsonpCallback : 'getJson',
      success : function (data) {
        powiaty_84 = L.geoJson(data, {
          style: function (feature) {
            return {
              color: 'black',
              fillColor: 'red',
              opacity: 0.5,
              weight: 1
            };},
          onEachFeature: function (feature, layer) {
            map.fitBounds(layer.getBounds()); 
          }

        });
        powiaty_84.addTo(map);
      }});
  }


//dodanie funkcji zasieg do zdarzenia click
  var setButton2 = document.getElementById('set2'); 
  setButton2.addEventListener('click', zasieg);

//cofniecie do domyslengo widoku
  var clearButton2 = document.getElementById('clear2'); 
  clearButton2.addEventListener('click', wymaz);



  //filtrowanie wedlug wieku

  // funkcja resetująca  filtrowanie po feature 
  //_layers lista okiektow w warstwie
  function setFeaturesVisible() {
    for(let key in grody._layers) { //iteracja po warstwach 
      const feature = grody._layers[key]._layers; // uzyskanie dostepu do feature
      console.log(feature, 'feature');
      for(let key2 in feature) {
        feature[key2].setOpacity(1); // ustawienie nieprzezroczystosci,widocznoscis
      }
    }
  }

  //po nacisnieciu przycisku wszystkie punkty są widoczne
  var clearButton3 = document.getElementById('clear3'); 
  clearButton3.addEventListener('click', setFeaturesVisible);


//wybiera zaznaczone checkboxy
  function getCheckedCheckboxes() {
    const checkedBoxes = [];
    $('input:checkbox[type=checkbox]:checked').each(function(){
      checkedBoxes.push($(this).val()); //dodanie do tablicy zaznaczonego wieku
    });
    return checkedBoxes;  //zwraca tablice z wartościami
  }

/*funkcja filtrujaca według wieku*/
  function filterByAges(checkedBoxes) {
    for(let key in grody._layers) { //iteracja po liście obiektow w warstwie 
      const feature = grody._layers[key]; //uzyskanie pojedynczego obiektu w warstwie grody poprzez indeks [key]
      console.log(feature);
      const wieki = feature.feature.properties.informacje; //uzyskanie dostepu  do wieku, który znajduje sie w kolumnie informacje
      const wiekiArray = wieki.split(' '); // napisy na tablice
      var hasCommonAges = wiekiArray.filter(function(e) { 
        return checkedBoxes.indexOf(e) > -1; // zwraca liste wspólnych wieków
      });
      if(hasCommonAges.length === 0) { 
        for(let key2 in feature._layers) {
          feature._layers[key2].setOpacity(0); //ustawia przezroczystość dla grodów, które nie zawierają zaznaczonego wieku
        }
      }
    }
  }


/*połączenie funkcji z przyciskiem 'szukaj' za pomoca id search */
  var setButton3 = document.getElementById('search'); 
  setButton3.addEventListener('click', () => {
    setFeaturesVisible();
    const checkedBoxes = getCheckedCheckboxes(); //do zmiennej przypisane są wybrane wieki
    if(checkedBoxes.length) { 
      filterByAges(checkedBoxes); 
    }
  });

  

  //wyszukiwarka
  function wyszukiwarka() {
    var viewparams = ['nazwa:' + document.getElementById('wstaw').value];
    var defaultParam = {
      service: 'WFS',
      version: '1.1.0',
      request: 'GetFeature',
      typeName: ' grody:wyszukiwarka',
      maxFeatures: 1000,
      outputFormat: 'json',
      format_options: 'callback:getJson',
      srsName: 'epsg:4326',
      viewparams:  viewparams.join(';')
    };
    var parameters = L.Util.extend(defaultParam);
    var URL = gs_url + L.Util.getParamString(parameters);

    $.ajax({
      url : URL,
      type: 'POST',
      dataType : 'json',
      success : function (response) {
        wyszukaj = L.geoJson(response, { 
          pointToLayer: function (feature, latlng) { 
            return L.marker(latlng,{icon:ikona});
          }, 
          onEachFeature: function (feature, layer) {
            var popup = new L.Popup();
            popup.setContent(feature.properties.nazwa + '<li><b>Opis:</b> ' + feature.properties.opis +  '</li><li><b>Wiek:</b> ' + feature.properties.informacje + '</li><li><b>Źródło:</b> ' + feature.properties.zrodlo + '</li>');
            layer.bindPopup(popup);

  			
          }

        });
        wyszukaj.addTo(map);
        map.fitBounds(wyszukaj.getBounds()); 
      }});
  }


//połączenie funkcji wszukiwarka z przyciskiem 'szukaj' za pomoca id search1

var setButton3 = document.getElementById('search1'); 
setButton3.addEventListener('click', wyszukiwarka);


//dodanie funkcji do przycisku
var clearButton3 = document.getElementById('clear4'); 
clearButton3.addEventListener('click', wymaz);

//dodanie kontrolki skali mapy
L.control.scale().addTo(map);
//dodanie kontrolki pozycji myszki
L.control.coordinates({position:'bottomright'}).addTo(map);





   </script>
  </body>
</html>